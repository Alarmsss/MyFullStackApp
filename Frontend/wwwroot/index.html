<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Frontend</title>
    <base href="/" />
    <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="icon.png" type="image/png">
    <link href="Frontend.styles.css" rel="stylesheet" />
    <style>
        :root {
            --app-blue: #2196F3;
            --light-blue: #64B5F6;
            --white: #ffffff;
            --bg-blue: #1976D2;
            --check-blue: #42A5F5;
        }

        /* å…¨åŸŸå­—é«”è¨­å®š */
        body {
            margin: 0;
            font-family: 
                'Noto Sans TC',
                'PingFang TC',
                'Microsoft JhengHei',
                -apple-system,
                BlinkMacSystemFont,
                'Segoe UI',
                Roboto,
                'Helvetica Neue',
                Arial,
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }

        /* éš±è— Blazor é è¨­çš„ loading å‹•ç•« */
        .loading-progress {
            display: none !important;
        }
        
        .loading-progress-text {
            display: none !important;
        }

        /* åˆå§‹ç‹€æ…‹ï¼šéš±è— Blazor æ‡‰ç”¨ */
        #app {
            opacity: 0;
            transition: opacity 0.3s ease-out;
            position: relative;
            min-height: 100vh;
            display: block;
        }

        #app.fade-in {
            opacity: 1;
        }

        /* è¼‰å…¥å‹•ç•«å®¹å™¨ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh; /* æ”¯æ´å‹•æ…‹è¦–å£é«˜åº¦ */
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            overflow: hidden;
            box-sizing: border-box;
        }

        .loading-screen.fade-out {
            opacity: 0;
            transition: opacity 0.3s ease-out;
            pointer-events: none;
        }

        .loading-container {
            position: relative;
            width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            box-sizing: content-box;
        }

        .app-icon {
            width: 120px;
            height: 120px;
            margin-bottom: 3rem;
            animation: icon-float 3s ease-in-out infinite;
            filter: drop-shadow(0 10px 15px rgba(33, 150, 243, 0.3));
            -webkit-user-select: none;
            user-select: none;
        }

        .todo-list {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: var(--white);
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 15px 30px rgba(33, 150, 243, 0.15);
            box-sizing: content-box;
        }

        .todo-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            opacity: 0;
            transform: translateY(20px);
            width: 100%;
            box-sizing: border-box;
            will-change: transform, opacity;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            visibility: hidden;
        }

        .todo-item.animate {
            visibility: visible;
            animation: slide-in 0.15s ease-out forwards;
        }

        .todo-item.animate .checkbox,
        .todo-item.animate .line {
            visibility: visible;
            opacity: 1;
        }

        .todo-item:not(.animate) .checkbox,
        .todo-item:not(.animate) .line {
            visibility: hidden;
            opacity: 0;
        }

        .todo-item:nth-child(1).animate { animation-delay: 0s; }
        .todo-item:nth-child(2).animate { animation-delay: 0.05s; }
        .todo-item:nth-child(3).animate { animation-delay: 0.1s; }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--app-blue);
            border-radius: 4px;
            position: relative;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .checkbox.checked {
            background: var(--check-blue);
            border-color: var(--check-blue);
        }

        .checkbox.checked::after {
            content: '';
            position: absolute;
            top: 45%;
            left: 50%;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: translate(-50%, -50%) rotate(45deg);
            animation: check-mark 0.3s ease-out forwards;
        }

        .line {
            height: 10px;
            background: var(--light-blue);
            border-radius: 5px;
            flex-grow: 1;
            opacity: 0.2;
            animation: pulse 2s ease-in-out infinite;
        }

        .loading-text {
            color: var(--app-blue);
            font-size: 1.25rem;
            font-weight: 500;
            margin-top: 2rem;
            letter-spacing: 0.05em;
        }

        .loading-dots {
            display: inline-block;
            margin-left: 0.5rem;
        }

        @keyframes icon-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes slide-in {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes check-mark {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) rotate(45deg) scale(0.5);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) rotate(45deg) scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.4; }
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite steps(4, end);
        }

        @keyframes dots {
            0% { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
            100% { content: ''; }
        }

        /* æ‰‹æ©Ÿç‰ˆæ¨£å¼ */
        @media (max-width: 768px) {
            .loading-screen {
                padding: 1rem;
            }

            .loading-container {
                width: 100%;
                max-width: 280px;
                padding: 1.5rem;
            }

            .app-icon {
                width: 80px;
                height: 80px;
                margin-bottom: 2rem;
                filter: drop-shadow(0 8px 12px rgba(33, 150, 243, 0.3));
            }

            .todo-list {
                gap: 0.75rem;
                padding: 1rem;
                border-radius: 12px;
                box-shadow: 0 10px 20px rgba(33, 150, 243, 0.15);
            }

            .todo-item {
                gap: 0.75rem;
            }

            .checkbox {
                width: 18px;
                height: 18px;
            }

            .checkbox.checked::after {
                width: 4px;
                height: 8px;
            }

            .line {
                height: 8px;
                border-radius: 4px;
            }

            .loading-text {
                font-size: 1rem;
                margin-top: 1.5rem;
            }

            .loading-dots {
                margin-left: 0.25rem;
            }

            @keyframes icon-float {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-8px); }
            }
        }

        /* è¼ƒå°è¢å¹•çš„å„ªåŒ– */
        @media screen and (max-width: 768px) and (max-height: 480px) {
            .app-icon {
                width: 60px;
                height: 60px;
                margin-bottom: 1.5rem;
            }

            .todo-list {
                gap: 0.5rem;
                padding: 0.75rem;
            }

            .loading-text {
                margin-top: 1rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>

<body>
    <!-- è¼‰å…¥å‹•ç•« -->
    <div class="loading-screen">
        <div class="loading-container">
            <img src="icon.png" alt="App Icon" class="app-icon">
            <div class="todo-list">
                <div class="todo-item">
                    <div class="checkbox checked"></div>
                    <div class="line"></div>
                </div>
                <div class="todo-item">
                    <div class="checkbox"></div>
                    <div class="line"></div>
                </div>
                <div class="todo-item">
                    <div class="checkbox"></div>
                    <div class="line"></div>
                </div>
            </div>
            <div class="loading-text">
                è¼‰å…¥ä¸­<span class="loading-dots"></span>
            </div>
        </div>
    </div>

    <!-- Blazor æ‡‰ç”¨å®¹å™¨ -->
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ğŸ—™</a>
    </div>

    <script>
        // è¿½è¹¤è³‡æºè¼‰å…¥é€²åº¦
        let checkboxes = document.querySelectorAll('.checkbox');
        console.log('æ‰¾åˆ°çš„ checkbox æ•¸é‡:', checkboxes.length);

        let currentIndex = 0; // ä¿®æ”¹åˆå§‹ç´¢å¼•ç‚º 0ï¼Œå› ç‚ºç¬¬ä¸€å€‹å·²ç¶“æ‰“å‹¾
        let progressInterval;
        let isRemoving = false;
        let loadingStartTime = 0;
        let isBlazorReady = false; // è¿½è¹¤ Blazor æ˜¯å¦å·²æº–å‚™å°±ç·’
        let isForward = true; // æ§åˆ¶å‹•ç•«æ–¹å‘
        let animationInterval = 500; // çµ±ä¸€çš„å‹•ç•«é–“éš”æ™‚é–“
        let isAnimationStopped = false; // æ–°å¢ï¼šè¿½è¹¤å‹•ç•«æ˜¯å¦å·²åœæ­¢
        let animationListeners = []; // æ–°å¢ï¼šå„²å­˜äº‹ä»¶ç›£è½å™¨å¼•ç”¨
        let isInitialized = false;
        let listenerMap = new Map();
        let completedAnimationsSet = new Set();
        let minimumDisplayTime = 1000;
        let animationStartTime = 0;
        let animationsInProgress = new Set(); // æ–°å¢ï¼šè¿½è¹¤æ­£åœ¨é€²è¡Œçš„å‹•ç•«
        let blazorLoaded = false; // æ–°å¢ï¼šè¿½è¹¤ Blazor è¼‰å…¥ç‹€æ…‹

        // æ›´æ–° checkbox ç‹€æ…‹çš„å‡½æ•¸
        function nextCheckbox() {
            if (isAnimationStopped) {
                return;
            }
            
            const currentTime = Date.now();
            console.log(`[${currentTime}] åŸ·è¡Œ nextCheckbox, ç•¶å‰ç´¢å¼•: ${currentIndex}, æ–¹å‘: ${isForward ? 'æ­£å‘' : 'åå‘'}`);
            
            if (isForward) {
                currentIndex++;
                if (currentIndex < checkboxes.length) {
                    console.log(`[${currentTime}] æ‰“å‹¾ç¬¬ ${currentIndex + 1} å€‹ checkbox`);
                    checkboxes[currentIndex].classList.add('checked');
                    console.log(`[${currentTime}] å·²æ·»åŠ  checked class`);
                } else {
                    console.log(`[${currentTime}] å·²åˆ°é”æœ€å¾Œï¼Œæº–å‚™åå‘`);
                    isForward = false;
                    currentIndex = 0;
                    nextCheckbox();
                    return;
                }
            } else {
                if (currentIndex < checkboxes.length) {
                    console.log(`[${currentTime}] å–æ¶ˆæ‰“å‹¾ç¬¬ ${currentIndex + 1} å€‹ checkbox`);
                    checkboxes[currentIndex].classList.remove('checked');
                    console.log(`[${currentTime}] å·²ç§»é™¤ checked class`);
                    currentIndex++;
                } else {
                    console.log(`[${currentTime}] å·²å›åˆ°èµ·é»ï¼Œæº–å‚™æ­£å‘`);
                    isForward = true;
                    currentIndex = -1;
                    nextCheckbox();
                    return;
                }
            }
        }

        // ç§»é™¤è¼‰å…¥ç•«é¢çš„å‡½æ•¸
        function removeLoadingScreen() {
            if (isRemoving) {
                console.log('æ­£åœ¨ç§»é™¤ä¸­ï¼Œè·³é');
                return;
            }
            
            const currentTime = Date.now();
            console.log(`[${currentTime}] é–‹å§‹åœæ­¢å‹•ç•«`);
            
            // åœæ­¢å‹•ç•«
            isAnimationStopped = true;
            
            // æ¸…é™¤å‹•ç•« interval
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
                console.log(`[${currentTime}] å·²æ¸…é™¤å‹•ç•« interval`);
            }
            
            // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›£è½å™¨
            listenerMap.forEach((listeners, element) => {
                element.removeEventListener('animationstart', listeners.startListener);
                element.removeEventListener('animationend', listeners.endListener);
            });
            listenerMap.clear();
            
            // ä½¿ç”¨ requestAnimationFrame ç¢ºä¿åœ¨ä¸‹ä¸€å¹€åŸ·è¡Œç§»é™¤æ“ä½œ
            requestAnimationFrame(() => {
                isRemoving = true;
                console.log(`[${currentTime}] é–‹å§‹ç§»é™¤è¼‰å…¥ç•«é¢`);
                
                const loadingScreen = document.querySelector('.loading-screen');
                const app = document.getElementById('app');
                
                if (!loadingScreen) {
                    console.log(`[${currentTime}] è¼‰å…¥ç•«é¢å·²ä¸å­˜åœ¨`);
                    isRemoving = false;
                    return;
                }
                
                app.style.display = 'block';
                app.style.opacity = '1';
                
                loadingScreen.classList.add('fade-out');
                
                setTimeout(() => {
                    if (loadingScreen && loadingScreen.parentNode) {
                        loadingScreen.remove();
                        console.log(`[${currentTime}] å·²ç§»é™¤è¼‰å…¥ç•«é¢å…ƒç´ `);
                    }
                    isRemoving = false;
                }, 300);
            });
        }

        function initializeCheckboxes() {
            const checkboxes = document.querySelectorAll('.checkbox');
            checkboxes.forEach((checkbox, index) => {
                checkbox.addEventListener('animationend', () => {
                    console.log(`Checkbox ${index + 1} animation ended`);
                });
            });
        }

        // åˆå§‹åŒ–å‡½æ•¸
        function initialize() {
            if (isInitialized) {
                console.log('å·²ç¶“åˆå§‹åŒ–éï¼Œè·³é');
                return;
            }

            const currentTime = Date.now();
            console.log(`[${currentTime}] é–‹å§‹åˆå§‹åŒ–`);
            
            const app = document.getElementById('app');
            app.style.display = 'none';
            app.style.opacity = '0';
            console.log(`[${currentTime}] å·²è¨­ç½® app å…ƒç´ ç‚ºéš±è—`);

            loadingStartTime = currentTime;
            console.log(`[${currentTime}] è¨˜éŒ„é–‹å§‹æ™‚é–“: ${loadingStartTime}`);
            
            // é‡ç½®æ‰€æœ‰ checkbox ç‹€æ…‹ï¼Œä½†ä¿æŒç¬¬ä¸€å€‹ç‚ºå·²é¸ä¸­
            for (let i = 1; i < checkboxes.length; i++) {
                checkboxes[i].classList.remove('checked');
                console.log(`[${currentTime}] é‡ç½®ç¬¬ ${i + 1} å€‹ checkbox`);
            }
            
            currentIndex = 0; // å¾ 0 é–‹å§‹ï¼Œå› ç‚ºç¬¬ä¸€å€‹å·²ç¶“æ‰“å‹¾
            isForward = true;

            // æ¸…é™¤å·²å®Œæˆå‹•ç•«çš„é›†åˆ
            completedAnimationsSet.clear();
            animationsInProgress.clear();

            // ç§»é™¤æ‰€æœ‰èˆŠçš„äº‹ä»¶ç›£è½å™¨
            listenerMap.forEach((listeners, element) => {
                element.removeEventListener('animationstart', listeners.startListener);
                element.removeEventListener('animationend', listeners.endListener);
            });
            listenerMap.clear();

            // é‡ç½®å‹•ç•«ç‹€æ…‹
            const todoItems = document.querySelectorAll('.todo-item');
            console.log(`[${currentTime}] æ‰¾åˆ° ${todoItems.length} å€‹ todo-item å…ƒç´ `);
            
            // è¨­ç½®åˆå§‹ç‹€æ…‹
            todoItems.forEach((item, index) => {
                console.log(`[${currentTime}] æº–å‚™ç¬¬ ${index + 1} å€‹ todo-item`);
                // é‡ç½® todo-item çš„ç‹€æ…‹
                item.style.opacity = '0';
                item.style.transform = 'translateY(20px)';
                item.style.visibility = 'hidden';
                item.classList.remove('animate');
            });

            let completedAnimations = 0;
            let allAnimationsCompleted = false;
            
            todoItems.forEach((item, index) => {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ·»åŠ éç›£è½å™¨
                if (listenerMap.has(item)) {
                    console.log(`[${currentTime}] ç¬¬ ${index + 1} å€‹ checkbox å·²ç¶“æœ‰ç›£è½å™¨ï¼Œè·³é`);
                    return;
                }

                const startListener = () => {
                    if (isAnimationStopped || blazorLoaded) return;
                    const startTime = Date.now();
                    if (index === 0) {
                        animationStartTime = startTime;
                    }
                    animationsInProgress.add(item);
                    item.classList.add('animate');
                    console.log(`[${startTime}] ç¬¬ ${index + 1} å€‹ checkbox é–‹å§‹æ»‘å…¥å‹•ç•«`);
                };
                const endListener = () => {
                    if (isAnimationStopped) return;
                    
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“è§¸ç™¼éé€™å€‹å…ƒç´ çš„å‹•ç•«å®Œæˆäº‹ä»¶
                    if (completedAnimationsSet.has(item)) {
                        console.log(`[${Date.now()}] ç¬¬ ${index + 1} å€‹ checkbox çš„å‹•ç•«å®Œæˆäº‹ä»¶å·²è§¸ç™¼éï¼Œè·³é`);
                        return;
                    }
                    
                    const endTime = Date.now();
                    console.log(`[${endTime}] ç¬¬ ${index + 1} å€‹ checkbox å®Œæˆæ»‘å…¥å‹•ç•«`);
                    completedAnimationsSet.add(item);
                    animationsInProgress.delete(item);
                    completedAnimations++;
                    
                    // ç•¶æ‰€æœ‰æ»‘å…¥å‹•ç•«å®Œæˆå¾Œï¼Œé–‹å§‹ checkbox å‹•ç•«
                    if (completedAnimations === todoItems.length) {
                        console.log(`[${endTime}] æ‰€æœ‰æ»‘å…¥å‹•ç•«å®Œæˆï¼Œé–‹å§‹ checkbox å‹•ç•«`);
                        allAnimationsCompleted = true;
                        // ç­‰å¾…ä¸€å°æ®µæ™‚é–“ç¢ºä¿è¦–è¦ºæ•ˆæœå®Œæ•´
                        setTimeout(() => {
                            // è¨­ç½®å®šæ™‚å™¨ï¼Œå¾ç¬¬äºŒå€‹ checkbox é–‹å§‹
                            progressInterval = setInterval(nextCheckbox, animationInterval);
                            console.log(`[${Date.now()}] å·²è¨­ç½®å®šæ™‚å™¨ï¼Œé–“éš” ${animationInterval}ms`);
                        }, 100);
                    }
                };

                item.addEventListener('animationstart', startListener);
                item.addEventListener('animationend', endListener);

                // ä¿å­˜ç›£è½å™¨å¼•ç”¨
                listenerMap.set(item, { startListener, endListener });
                console.log(`[${currentTime}] å·²ç‚ºç¬¬ ${index + 1} å€‹ checkbox æ·»åŠ äº‹ä»¶ç›£è½å™¨`);
            });

            // é–‹å§‹å‹•ç•«
            setTimeout(() => {
                todoItems.forEach((item, index) => {
                    if (!blazorLoaded) {
                        item.classList.add('animate');
                    }
                });
            }, 50);
            
            isInitialized = true;
        }

        // ç­‰å¾… Blazor è…³æœ¬è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        function waitForBlazor() {
            console.log('æª¢æŸ¥ Blazor æ˜¯å¦å¯ç”¨');
            if (window.Blazor) {
                console.log('Blazor å·²å¯ç”¨ï¼Œé–‹å§‹åˆå§‹åŒ–');
                // ç¢ºä¿ DOM å®Œå…¨è¼‰å…¥å¾Œå†åˆå§‹åŒ–
                if (document.readyState === 'complete') {
                    initialize();
                } else {
                    window.addEventListener('load', initialize);
                }
            } else {
                console.log('Blazor å°šæœªå¯ç”¨ï¼Œç­‰å¾…ä¸­...');
                setTimeout(waitForBlazor, 100);
            }
        }

        // ç›£è½ Blazor è³‡æºè¼‰å…¥ç‹€æ…‹
        function monitorBlazorLoading() {
            if (window.Blazor) {
                const currentTime = Date.now();
                console.log(`[${currentTime}] é–‹å§‹ç›£è½ Blazor è¼‰å…¥ç‹€æ…‹`);
                
                // ä½¿ç”¨ Blazor çš„ start() æ–¹æ³•
                window.Blazor.start().then(() => {
                    const readyTime = Date.now();
                    console.log(`[${readyTime}] Blazor è³‡æºè¼‰å…¥å®Œæˆ`);
                    handleBlazorLoaded();
                }).catch(error => {
                    console.error('Blazor å•Ÿå‹•å¤±æ•—:', error);
                });
            }
        }

        // è™•ç† Blazor è¼‰å…¥å®Œæˆå¾Œçš„é‚è¼¯
        function handleBlazorLoaded() {
            const currentTime = Date.now();
            console.log(`[${currentTime}] é–‹å§‹è™•ç† Blazor è¼‰å…¥å®Œæˆå¾Œçš„é‚è¼¯`);
            
            blazorLoaded = true;
            isBlazorReady = true;
            
            // ç«‹å³åœæ­¢æ‰€æœ‰æœªé–‹å§‹çš„å‹•ç•«
            const todoItems = document.querySelectorAll('.todo-item');
            todoItems.forEach(item => {
                if (!animationsInProgress.has(item)) {
                    item.classList.remove('animate');
                    item.style.opacity = '0';
                    item.style.transform = 'translateY(20px)';
                    item.style.visibility = 'hidden';
                }
            });
            
            // ç§»é™¤è¼‰å…¥ç•«é¢
            removeLoadingScreen();
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM å·²è¼‰å…¥å®Œæˆï¼Œé–‹å§‹ç­‰å¾… Blazor');
            waitForBlazor();
        });

        // ç›£è½ Blazor è…³æœ¬è¼‰å…¥å®Œæˆäº‹ä»¶
        window.addEventListener('load', () => {
            if (window.Blazor) {
                monitorBlazorLoading();
            }
        });
    </script>

    <script src="_framework/blazor.webassembly.js" autostart="false"></script>
</body>

</html>
